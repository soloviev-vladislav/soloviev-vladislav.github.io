<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voronka.hh - Воронка HH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .autocomplete-dropdown { position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); width: 100%; }
        .autocomplete-item { padding: 0.5rem 1rem; cursor: pointer; }
        .autocomplete-item:hover { background-color: #f3f4f6; }
        .tag { display: inline-flex; align-items: center; background-color: #e0f2fe; color: #0369a1; padding: 0.25rem 0.75rem; border-radius: 9999px; margin: 0.25rem; font-size: 0.875rem; }
        .tag-remove { margin-left: 0.5rem; cursor: pointer; font-weight: bold; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid #3F7FBF; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .company-card { transition: transform 0.2s, box-shadow 0.2s; }
        .company-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .user-badge { 
            display: inline-flex; 
            align-items: center; 
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; 
            padding: 0.5rem 1rem; 
            border-radius: 9999px; 
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .balance-badge { 
            display: inline-flex; 
            align-items: center; 
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white; 
            padding: 0.5rem 1rem; 
            border-radius: 9999px; 
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .insufficient-balance {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Блок с именем пользователя и балансом -->
        <div class="flex justify-between items-center mb-6">
            <!-- Имя пользователя слева -->
            <div class="user-badge">
                <i class="fas fa-user-circle mr-2"></i>
                <span id="username">Загрузка...</span>
            </div>
            
            <!-- Баланс справа -->
            <div class="balance-badge">
                <i class="fas fa-coins mr-2"></i>
                <span id="userBalance">Загрузка...</span>
            </div>
        </div>

        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Воронка HH</h1>
            <p class="text-gray-600 mt-2">Поиск компаний по вакансиям с HeadHunter</p>
        </header>

        <main class="max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-md p-6 mb-10">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Параметры поиска</h2>
                
                <form id="searchForm">
                    <div class="mb-6">
                        <label for="vacancy" class="block text-gray-700 font-medium mb-2">Вакансия *</label>
                        <input type="text" id="vacancy" name="vacancy" placeholder="Например, бухгалтер" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition"
                            value="бухгалтер">
                    </div>
                    
                    <div class="mb-6">
                        <p class="block text-gray-700 font-medium mb-2">Искать в:</p>
                        <div class="flex flex-col md:flex-row gap-3">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="search_in_name" name="search_in" value="name" checked class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">Название вакансии</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="search_in_company" name="search_in" value="company" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">Название компании</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="professional_roles_input" class="block text-gray-700 font-medium mb-2">Роль</label>
                        <div class="relative">
                            <input type="text" id="professional_roles_input" placeholder="Начните вводить роль" autocomplete="off"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition">
                            <div id="professional_roles_dropdown" class="autocomplete-dropdown hidden"></div>
                        </div>
                        <div id="professional_roles_tags" class="mt-3 flex flex-wrap"></div>
                        <input type="hidden" id="professional_roles" name="professional_roles">
                    </div>
                    
                    <div class="mb-6">
                        <label for="areas_input" class="block text-gray-700 font-medium mb-2">Регион</label>
                        <div class="relative">
                            <input type="text" id="areas_input" placeholder="Начните вводить регион" autocomplete="off"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition">
                            <div id="areas_dropdown" class="autocomplete-dropdown hidden"></div>
                        </div>
                        <div id="areas_tags" class="mt-3 flex flex-wrap"></div>
                        <input type="hidden" id="areas" name="areas">
                    </div>
                    
                    <div class="mb-6">
                        <label for="industries_input" class="block text-gray-700 font-medium mb-2">Вид деятельности</label>
                        <div class="relative">
                            <input type="text" id="industries_input" placeholder="Начните вводить вид деятельности" autocomplete="off"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition">
                            <div id="industries_dropdown" class="autocomplete-dropdown hidden"></div>
                        </div>
                        <div id="industries_tags" class="mt-3 flex flex-wrap"></div>
                        <input type="hidden" id="industries" name="industries">
                    </div>
                    
                    <div class="mb-8">
                        <label for="limit" class="block text-gray-700 font-medium mb-2">Ограничить выдачу</label>
                        <input type="number" id="limit" name="limit" placeholder="Например, 50" min="1" max="2000"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition"
                            value="50">
                        <div id="limitWarning" class="hidden mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 mr-2"></i>
                                <div>
                                    <p class="text-yellow-700 font-medium">Недостаточно средств</p>
                                    <p class="text-yellow-600 text-sm">Ваш баланс: <span id="currentBalanceDisplay" class="font-bold">0</span> компаний. 
                                    Для запроса <span id="requestedLimit" class="font-bold">0</span> компаний необходимо пополнить баланс.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" id="submitBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-search mr-2"></i> Найти компании
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="mb-10">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Результаты поиска</h2>
                    <span id="resultsCount" class="text-gray-600 hidden">Найдено: <span class="font-semibold">0</span></span>
                </div>
                
                <div id="loadingState" class="hidden text-center py-10">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-700">Идет поиск компаний...</p>
                </div>
                
                <div id="errorState" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                    <h3 class="text-red-700 font-semibold text-lg mb-2">Произошла ошибка</h3>
                    <p id="errorMessage" class="text-red-600 mb-4"></p>
                    <button id="retryButton" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition">
                        Попробовать снова
                    </button>
                </div>
                
                <div id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full text-center text-gray-500 py-10">
                        <i class="fas fa-building text-4xl mb-4 opacity-30"></i>
                        <p class="text-lg mb-2">Здесь появятся результаты поиска</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // КОНФИГУРАЦИЯ
        const N8N_WEBHOOK_URL = 'https://n8n.pipegun.ru/webhook/voronka';
        const BALANCE_API_URL = 'https://n8n.pipegun.ru/webhook/balance';
        const SPEND_API_URL = 'https://n8n.pipegun.ru/webhook/spend';
        const HH_API = {
            professional_roles: 'https://api.hh.ru/professional_roles',
            areas: 'https://api.hh.ru/areas',
            industries: 'https://api.hh.ru/industries'
        };
        
        // СЕССИЯ И ИСТОРИЯ ПОИСКА
        const STORAGE_KEY = 'voronka_search_history';
        let currentSession = {
            userId: null,
            username: null,
            searchHistory: [],
            lastResults: null,
            currentBalance: 0,
            lastSpendId: null
        };
        
        let autocompleteData = {
            professional_roles: [],
            areas: [],
            industries: []
        };
        
        let selectedValues = {
            professional_roles: new Map(),
            areas: new Map(),
            industries: new Map()
        };
        
        let debounceTimers = {};
        
        // ФУНКЦИЯ ДЛЯ ПОЛУЧЕНИЯ ПАРАМЕТРОВ ИЗ URL
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                id: urlParams.get('id'),
                username: urlParams.get('username')
            };
        }
        
        // ФУНКЦИИ ДЛЯ РАБОТЫ С СЕССИЕЙ И ИСТОРИЕЙ
        function loadSession() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    currentSession = {
                        ...currentSession,
                        ...parsed
                    };
                    
                    // Восстанавливаем последние результаты
                    if (currentSession.lastResults) {
                        displayResults(currentSession.lastResults, true);
                    }
                }
            } catch (e) {
                console.error('Ошибка загрузки сессии:', e);
                clearSession();
            }
        }
        
        function saveSession() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSession));
            } catch (e) {
                console.error('Ошибка сохранения сессии:', e);
            }
        }
        
        function clearSession() {
            currentSession = {
                userId: null,
                username: null,
                searchHistory: [],
                lastResults: null,
                currentBalance: 0,
                lastSpendId: null
            };
            localStorage.removeItem(STORAGE_KEY);
        }
        
        function addToHistory(searchParams, results) {
            if (!currentSession.userId) return;
            
            const historyItem = {
                timestamp: new Date().toISOString(),
                params: searchParams,
                resultsCount: Array.isArray(results) ? results.length : 
                    (results.companies ? results.companies.length : 0)
            };
            
            currentSession.searchHistory.unshift(historyItem);
            // Храним только последние 10 запросов
            currentSession.searchHistory = currentSession.searchHistory.slice(0, 10);
            
            currentSession.lastResults = results;
            
            saveSession();
        }
        
        // ФУНКЦИЯ ДЛЯ СПИСАНИЯ БАЛАНСА (ИСПРАВЛЕННАЯ)
        async function spendBalance(amount, searchQuery) {
            try {
                console.log('=== НАЧАЛО СПИСАНИЯ БАЛАНСА ===');
                console.log('Текущая сессия:', currentSession);
                console.log('Параметры списания:', { amount, searchQuery });
                
                // Проверяем, не списывали ли уже за этот поиск
                if (currentSession.lastSpendId) {
                    console.log('Баланс уже был списан за этот поиск, ID:', currentSession.lastSpendId);
                    return false;
                }
                
                if (!currentSession.userId) {
                    console.warn('Нет ID пользователя для списания баланса');
                    return false;
                }
                
                const spendData = {
                    user_id: currentSession.userId,
                    amount: amount,
                    search_query: searchQuery
                };
                
                console.log('Отправка данных на списание:', spendData);
                console.log('URL для списания:', SPEND_API_URL);
                
                // Отправляем запрос
                const response = await fetch(SPEND_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(spendData)
                });
                
                console.log('Статус ответа от spend API:', response.status);
                console.log('Статус текста:', response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Ошибка списания баланса: ${response.status} ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('Текст ответа:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Парсинг JSON успешен:', data);
                } catch (parseError) {
                    console.warn('Ответ не в формате JSON:', responseText);
                    data = { success: true, message: 'Баланс списан' };
                }
                
                // Сохраняем идентификатор списания для предотвращения повторного списания
                currentSession.lastSpendId = `spend_${Date.now()}_${amount}`;
                saveSession();
                
                // Обновляем баланс в интерфейсе если сервер вернул новый баланс
                if (data.new_balance !== undefined) {
                    console.log('Обновление баланса на:', data.new_balance);
                    updateBalance(data.new_balance);
                } else {
                    // Если сервер не вернул новый баланс, вычитаем локально
                    const newBalance = Math.max(0, currentSession.currentBalance - amount);
                    console.log('Вычитаем локально, новый баланс:', newBalance);
                    updateBalance(newBalance);
                }
                
                console.log('=== УСПЕШНОЕ СПИСАНИЕ БАЛАНСА ===');
                return true;
                
            } catch (error) {
                console.error('Ошибка при списании баланса:', error);
                console.error('Подробности ошибки:', {
                    message: error.message,
                    stack: error.stack
                });
                return false;
            }
        }
        
        // ФУНКЦИЯ ОБНОВЛЕНИЯ ИМЕНИ ПОЛЬЗОВАТЕЛЯ
        function updateUsername(username) {
            const usernameElement = document.getElementById('username');
            if (username) {
                usernameElement.textContent = username.startsWith('@') ? username : `@${username}`;
                currentSession.username = username;
            } else {
                usernameElement.textContent = '@guest';
                usernameElement.style.opacity = '0.7';
            }
        }
        
        // ФУНКЦИЯ ОБНОВЛЕНИЯ БАЛАНСА
        function updateBalance(balance) {
            const balanceElement = document.getElementById('userBalance');
            balanceElement.textContent = `${balance} компаний`;
            currentSession.currentBalance = balance;
            
            // Проверяем баланс при обновлении
            checkBalance();
        }
        
        // ФУНКЦИЯ ПРОВЕРКИ БАЛАНСА
        function checkBalance() {
            const limitInput = document.getElementById('limit');
            const submitBtn = document.getElementById('submitBtn');
            const limitWarning = document.getElementById('limitWarning');
            const currentBalanceDisplay = document.getElementById('currentBalanceDisplay');
            const requestedLimit = document.getElementById('requestedLimit');
            
            const requested = parseInt(limitInput.value) || 0;
            const currentBalance = currentSession.currentBalance || 0;
            
            // Обновляем отображение текущего баланса
            currentBalanceDisplay.textContent = currentBalance;
            requestedLimit.textContent = requested;
            
            if (requested > 0 && currentBalance < requested) {
                // Недостаточно средств
                submitBtn.disabled = true;
                limitWarning.classList.remove('hidden');
                
                // Добавляем анимацию к бейджу баланса
                document.querySelector('.balance-badge').classList.add('insufficient-balance');
                
                return false;
            } else {
                // Средств достаточно
                submitBtn.disabled = false;
                limitWarning.classList.add('hidden');
                
                // Убираем анимацию
                document.querySelector('.balance-badge').classList.remove('insufficient-balance');
                
                return true;
            }
        }
        
        // ФУНКЦИЯ ЗАГРУЗКИ ДАННЫХ ПОЛЬЗОВАТЕЛЯ
        async function loadUserData() {
            const params = getUrlParams();
            
            // Устанавливаем имя пользователя
            updateUsername(params.username);
            
            // Сохраняем ID пользователя в сессии
            if (params.id) {
                currentSession.userId = params.id;
                saveSession();
                
                // Загружаем баланс
                try {
                    console.log('Загрузка баланса для ID:', params.id);
                    const response = await fetch(`${BALANCE_API_URL}?id=${params.id}`);
                    
                    console.log('Ответ от баланса API:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`Ошибка загрузки баланса: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Данные баланса:', data);
                    
                    if (data.balance !== undefined) {
                        updateBalance(data.balance);
                    } else {
                        console.warn('Неожиданный формат ответа баланса:', data);
                        updateBalance(0);
                    }
                    
                } catch (error) {
                    console.error('Ошибка при загрузке баланса:', error);
                    updateBalance('Ошибка');
                    document.getElementById('userBalance').style.color = '#ef4444';
                }
            } else {
                updateBalance(0);
                document.getElementById('userBalance').style.opacity = '0.7';
            }
        }
        
        // ИНИЦИАЛИЗАЦИЯ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Страница загружена, начальная сессия:', currentSession);
            
            // Загружаем сессию
            loadSession();
            
            // Загружаем данные пользователя
            loadUserData();
            
            // Обработчик изменения поля "Ограничить выдачу"
            document.getElementById('limit').addEventListener('input', function() {
                checkBalance();
            });
            
            // Автокомплиты
            setupAutocomplete('professional_roles_input', 'professional_roles_dropdown', 
                'professional_roles_tags', 'professional_roles', 'professional_roles', dataMappers.professional_roles);
            setupAutocomplete('areas_input', 'areas_dropdown', 
                'areas_tags', 'areas', 'areas', dataMappers.areas);
            setupAutocomplete('industries_input', 'industries_dropdown', 
                'industries_tags', 'industries', 'industries', dataMappers.industries);
            
            // Обработчик формы
            document.getElementById('searchForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Проверяем баланс перед отправкой
                if (!checkBalance()) {
                    return;
                }
                
                const formData = {
                    vacancy: document.getElementById('vacancy').value.trim(),
                    search_in: Array.from(document.querySelectorAll('input[name="search_in"]:checked'))
                        .map(checkbox => checkbox.value),
                    professional_roles: document.getElementById('professional_roles').value
                        .split(',').filter(id => id !== '').map(id => parseInt(id)),
                    areas: document.getElementById('areas').value
                        .split(',').filter(id => id !== '').map(id => parseInt(id)),
                    industries: document.getElementById('industries').value
                        .split(',').filter(id => id !== '').map(id => parseInt(id)),
                    limit: document.getElementById('limit').value || 50
                };
                
                if (!formData.vacancy) {
                    alert('Введите вакансию');
                    return;
                }
                
                showLoading();
                await submitForm(formData);
            });
            
            // Кнопка "Попробовать снова"
            document.getElementById('retryButton').addEventListener('click', function() {
                document.getElementById('errorState').classList.add('hidden');
                document.getElementById('searchForm').dispatchEvent(new Event('submit'));
            });
        });

        // ФУНКЦИИ АВТОКОМПЛИТА
        function setupAutocomplete(inputId, dropdownId, tagsContainerId, hiddenInputId, apiEndpoint, dataMapper) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const tagsContainer = document.getElementById(tagsContainerId);
            const hiddenInput = document.getElementById(hiddenInputId);
            const type = hiddenInputId;
            
            input.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (debounceTimers[inputId]) clearTimeout(debounceTimers[inputId]);
                
                if (query.length < 2) {
                    dropdown.classList.add('hidden');
                    return;
                }
                
                debounceTimers[inputId] = setTimeout(async () => {
                    try {
                        dropdown.innerHTML = '<div class="autocomplete-item">Загрузка...</div>';
                        dropdown.classList.remove('hidden');
                        
                        const response = await fetch(HH_API[apiEndpoint]);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        
                        const data = await response.json();
                        autocompleteData[type] = dataMapper(data);
                        
                        const filtered = autocompleteData[type].filter(item => 
                            item.text.toLowerCase().includes(query.toLowerCase())
                        );
                        
                        dropdown.innerHTML = '';
                        
                        if (filtered.length === 0) {
                            const noResults = document.createElement('div');
                            noResults.className = 'autocomplete-item text-gray-500';
                            noResults.textContent = 'Ничего не найдено';
                            dropdown.appendChild(noResults);
                            return;
                        }
                        
                        filtered.slice(0, 10).forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'autocomplete-item';
                            div.textContent = item.text;
                            div.dataset.id = item.id;
                            div.dataset.text = item.text;
                            
                            div.addEventListener('click', () => {
                                addTag(item.id, item.text, type, tagsContainer, hiddenInput);
                                input.value = '';
                                dropdown.classList.add('hidden');
                            });
                            
                            dropdown.appendChild(div);
                        });
                        
                    } catch (error) {
                        dropdown.innerHTML = '<div class="autocomplete-item text-red-500">Ошибка загрузки</div>';
                    }
                }, 300);
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }
        
        function addTag(id, text, type, tagsContainer, hiddenInput) {
            if (selectedValues[type].has(id)) return;
            
            selectedValues[type].set(id, { id, text });
            updateHiddenInput(type, hiddenInput);
            
            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.innerHTML = `${text}<span class="tag-remove" data-id="${id}">&times;</span>`;
            
            tag.querySelector('.tag-remove').addEventListener('click', () => {
                removeTag(id, type, tag, hiddenInput);
            });
            
            tagsContainer.appendChild(tag);
        }
        
        function removeTag(id, type, tagElement, hiddenInput) {
            selectedValues[type].delete(id);
            tagElement.remove();
            updateHiddenInput(type, hiddenInput);
        }
        
        function updateHiddenInput(type, hiddenInput) {
            const ids = Array.from(selectedValues[type].keys());
            hiddenInput.value = ids.join(',');
        }
        
        const dataMappers = {
            professional_roles: (data) => {
                const items = [];
                data.categories.forEach(category => {
                    category.roles.forEach(role => {
                        items.push({ id: role.id, text: role.name });
                    });
                });
                return items;
            },
            areas: (data) => {
                const items = [];
                function processArea(area, path = '') {
                    const currentPath = path ? `${path} → ${area.name}` : area.name;
                    items.push({ id: area.id, text: currentPath });
                    if (area.areas) area.areas.forEach(child => processArea(child, currentPath));
                }
                data.forEach(area => processArea(area));
                return items;
            },
            industries: (data) => data.map(industry => ({ id: industry.id, text: industry.name }))
        };
        
        // ОСНОВНЫЕ ФУНКЦИИ
        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('resultsCount').classList.add('hidden');
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Идет поиск...';
        }
        
        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-search mr-2"></i> Найти компании';
        }
        
        function showError(message) {
            hideLoading();
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        // ОТПРАВКА ФОРМЫ С ID ПОЛЬЗОВАТЕЛЯ
        async function submitForm(formData) {
            try {
                console.log('=== НАЧАЛО ОТПРАВКИ ФОРМЫ ===');
                console.log('Данные формы:', formData);
                
                const params = new URLSearchParams();
                params.append('vacancy', formData.vacancy);
                params.append('search_in', formData.search_in.join(','));
                
                // ДОБАВЛЯЕМ ID ПОЛЬЗОВАТЕЛЯ ЕСЛИ ЕСТЬ
                if (currentSession.userId) {
                    params.append('user_id', currentSession.userId);
                    console.log('Добавлен user_id:', currentSession.userId);
                }
                
                if (formData.professional_roles.length > 0) {
                    params.append('professional_roles', formData.professional_roles.join(','));
                }
                
                if (formData.areas.length > 0) {
                    params.append('areas', formData.areas.join(','));
                }
                
                if (formData.industries.length > 0) {
                    params.append('industries', formData.industries.join(','));
                }
                
                if (formData.limit) {
                    params.append('limit', formData.limit);
                }
                
                const targetUrl = N8N_WEBHOOK_URL + '?' + params.toString();
                console.log('URL запроса поиска:', targetUrl);
                
                const response = await fetch(targetUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                console.log('Статус ответа от поиска:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Ошибка сервера: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Получены данные поиска:', data);
                
                // Сохраняем в историю
                addToHistory(formData, data);
                
                // Отображаем результаты
                displayResults(data);
                
                console.log('=== УСПЕШНОЕ ВЫПОЛНЕНИЕ ПОИСКА ===');
                
            } catch (error) {
                console.error('Ошибка при поиске:', error);
                showError(error.message);
            }
        }
        
        function displayResults(results, fromHistory = false) {
            console.log('=== НАЧАЛО ОТОБРАЖЕНИЯ РЕЗУЛЬТАТОВ ===');
            console.log('fromHistory:', fromHistory);
            console.log('Результаты:', results);
            
            hideLoading();
            
            const container = document.getElementById('resultsContainer');
            const resultsCount = document.getElementById('resultsCount');
            
            // Обрабатываем новый формат
            let resultsArray = [];
            
            // Формат 1: [{companies: [...]}] - новый формат
            if (Array.isArray(results) && results.length > 0 && results[0].companies) {
                console.log('Обнаружен новый формат с companies');
                resultsArray = results[0].companies;
            }
            // Формат 2: Просто массив компаний
            else if (Array.isArray(results)) {
                console.log('Простой массив компаний');
                resultsArray = results;
            }
            // Формат 3: {companies: [...]}
            else if (results && results.companies && Array.isArray(results.companies)) {
                console.log('Объект с полем companies');
                resultsArray = results.companies;
            }
            // Формат 4: {data: [...]}
            else if (results && results.data && Array.isArray(results.data)) {
                console.log('Объект с полем data');
                resultsArray = results.data;
            }
            
            console.log('Обработанный массив компаний:', resultsArray);
            console.log('Количество компаний:', resultsArray.length);
            
            // Если нет результатов
            if (resultsArray.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-10">
                        <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-gray-700 font-semibold text-lg mb-2">Ничего не найдено</h3>
                        <p class="text-gray-500">Попробуйте изменить параметры поиска</p>
                    </div>
                `;
                resultsCount.classList.add('hidden');
                return;
            }
            
            // СПИСЫВАЕМ БАЛАНС ТОЛЬКО ЕСЛИ НЕ ИЗ ИСТОРИИ
            if (!fromHistory && resultsArray.length > 0) {
                console.log('Начинаем списание баланса...');
                console.log('Текущий lastSpendId:', currentSession.lastSpendId);
                
                // Получаем поисковый запрос из формы
                const searchQuery = document.getElementById('vacancy').value.trim();
                console.log('Поисковый запрос для списания:', searchQuery);
                
                // Списываем баланс (количество найденных компаний)
                setTimeout(() => {
                    spendBalance(resultsArray.length, searchQuery);
                }, 100);
            } else if (fromHistory) {
                console.log('Пропускаем списание - результаты из истории');
            }
            
            // Очищаем контейнер
            container.innerHTML = '';
            
            // Создаем карточки
            resultsArray.forEach((company, index) => {
                const card = document.createElement('div');
                card.className = 'company-card bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300';
                
                const name = company.name || 'Название не указано';
                const website = company.site || company.website || '';
                const inn = company.inn || company.tax_id || 'Не указан';
                const hhLink = company.vacancy || company.url || company.hh_link || '';
                
                // Проверяем, не пустой ли сайт
                const displayWebsite = (website && website !== 'http://' && website !== 'https://' && website !== 'null' && website !== null) 
                    ? website 
                    : '';
                
                card.innerHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 truncate">${name}</h3>
                        
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="font-medium text-gray-700 min-w-[60px]">ИНН:</span>
                                <span class="text-gray-900 font-mono">${inn}</span>
                            </div>
                            
                            ${displayWebsite ? `
                            <div class="flex items-start">
                                <span class="font-medium text-gray-700 min-w-[60px]">Сайт:</span>
                                <a href="${displayWebsite}" target="_blank" rel="noopener noreferrer" 
                                   class="text-blue-600 hover:text-blue-800 hover:underline truncate flex-1">
                                    ${displayWebsite.replace(/^https?:\/\//, '').replace(/^http:\/\//, '')}
                                </a>
                            </div>
                            ` : ''}
                            
                            ${hhLink ? `
                            <div class="flex items-start">
                                <span class="font-medium text-gray-700 min-w-[60px]">HH.ru:</span>
                                <a href="${hhLink}" target="_blank" rel="noopener noreferrer" 
                                   class="text-blue-600 hover:text-blue-800 hover:underline truncate flex-1">
                                    Открыть вакансию
                                </a>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Показываем количество результатов
            resultsCount.classList.remove('hidden');
            resultsCount.innerHTML = `Найдено компаний: <span class="font-semibold text-blue-600">${resultsArray.length}</span>`;
            
            if (fromHistory) {
                resultsCount.innerHTML += ' <span class="text-gray-500 text-sm">(из истории)</span>';
            }
            
            // Прокручиваем к результатам если не из истории
            if (!fromHistory) {
                document.getElementById('resultsContainer').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }
            
            console.log('=== ЗАВЕРШЕНО ОТОБРАЖЕНИЕ РЕЗУЛЬТАТОВ ===');
        }
    </script>
</body>
</html>
