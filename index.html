<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voronka.hh - Воронка HH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .autocomplete-dropdown { position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); width: 100%; }
        .autocomplete-item { padding: 0.5rem 1rem; cursor: pointer; }
        .autocomplete-item:hover { background-color: #f3f4f6; }
        .tag { display: inline-flex; align-items: center; background-color: #e0f2fe; color: #0369a1; padding: 0.25rem 0.75rem; border-radius: 9999px; margin: 0.25rem; font-size: 0.875rem; }
        .tag-remove { margin-left: 0.5rem; cursor: pointer; font-weight: bold; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid #3F7FBF; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .company-card { transition: transform 0.2s, box-shadow 0.2s; }
        .company-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Воронка HH</h1>
            <p class="text-gray-600 mt-2">Поиск компаний по вакансиям с HeadHunter</p>
        </header>

        <main class="max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-md p-6 mb-10">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Параметры поиска</h2>
                
                <form id="searchForm">
                    <div class="mb-6">
                        <label for="vacancy" class="block text-gray-700 font-medium mb-2">Вакансия *</label>
                        <input type="text" id="vacancy" name="vacancy" placeholder="Например, бухгалтер" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition"
                            value="бухгалтер">
                    </div>
                    
                    <div class="mb-6">
                        <p class="block text-gray-700 font-medium mb-2">Искать в:</p>
                        <div class="flex flex-col md:flex-row gap-3">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="search_in_name" name="search_in" value="name" checked class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">Название вакансии</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="search_in_company" name="search_in" value="company" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">Название компании</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="professional_roles_input" class="block text-gray-700 font-medium mb-2">Роль</label>
                        <div class="relative">
                            <input type="text" id="professional_roles_input" placeholder="Начните вводить роль" autocomplete="off"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition">
                            <div id="professional_roles_dropdown" class="autocomplete-dropdown hidden"></div>
                        </div>
                        <div id="professional_roles_tags" class="mt-3 flex flex-wrap"></div>
                        <input type="hidden" id="professional_roles" name="professional_roles">
                    </div>
                    
                    <div class="mb-6">
                        <label for="areas_input" class="block text-gray-700 font-medium mb-2">Регион</label>
                        <div class="relative">
                            <input type="text" id="areas_input" placeholder="Начните вводить регион" autocomplete="off"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition">
                            <div id="areas_dropdown" class="autocomplete-dropdown hidden"></div>
                        </div>
                        <div id="areas_tags" class="mt-3 flex flex-wrap"></div>
                        <input type="hidden" id="areas" name="areas">
                    </div>
                    
                    <div class="mb-6">
                        <label for="industries_input" class="block text-gray-700 font-medium mb-2">Вид деятельности</label>
                        <div class="relative">
                            <input type="text" id="industries_input" placeholder="Начните вводить вид деятельности" autocomplete="off"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition">
                            <div id="industries_dropdown" class="autocomplete-dropdown hidden"></div>
                        </div>
                        <div id="industries_tags" class="mt-3 flex flex-wrap"></div>
                        <input type="hidden" id="industries" name="industries">
                    </div>
                    
                    <div class="mb-8">
                        <label for="limit" class="block text-gray-700 font-medium mb-2">Ограничить выдачу</label>
                        <input type="number" id="limit" name="limit" placeholder="Например, 50" min="1" max="2000"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition"
                            value="50">
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" id="submitBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <i class="fas fa-search mr-2"></i> Найти компании
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="mb-10">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Результаты поиска</h2>
                    <span id="resultsCount" class="text-gray-600 hidden">Найдено: <span class="font-semibold">0</span></span>
                </div>
                
                <div id="loadingState" class="hidden text-center py-10">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-700">Идет поиск компаний...</p>
                </div>
                
                <div id="errorState" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                    <h3 class="text-red-700 font-semibold text-lg mb-2">Произошла ошибка</h3>
                    <p id="errorMessage" class="text-red-600 mb-4"></p>
                    <button id="retryButton" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition">
                        Попробовать снова
                    </button>
                </div>
                
                <div id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full text-center text-gray-500 py-10">
                        <i class="fas fa-building text-4xl mb-4 opacity-30"></i>
                        <p class="text-lg mb-2">Здесь появятся результаты поиска</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // КОНФИГУРАЦИЯ
        const N8N_WEBHOOK_URL = 'https://n8n.pipegun.ru/webhook-test/voronka';
        const HH_API = {
            professional_roles: 'https://api.hh.ru/professional_roles',
            areas: 'https://api.hh.ru/areas',
            industries: 'https://api.hh.ru/industries'
        };
        
        let autocompleteData = {
            professional_roles: [],
            areas: [],
            industries: []
        };
        
        let selectedValues = {
            professional_roles: new Map(),
            areas: new Map(),
            industries: new Map()
        };
        
        let debounceTimers = {};
        
        // ФУНКЦИИ АВТОКОМПЛИТА
        function setupAutocomplete(inputId, dropdownId, tagsContainerId, hiddenInputId, apiEndpoint, dataMapper) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const tagsContainer = document.getElementById(tagsContainerId);
            const hiddenInput = document.getElementById(hiddenInputId);
            const type = hiddenInputId;
            
            input.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (debounceTimers[inputId]) clearTimeout(debounceTimers[inputId]);
                
                if (query.length < 2) {
                    dropdown.classList.add('hidden');
                    return;
                }
                
                debounceTimers[inputId] = setTimeout(async () => {
                    try {
                        dropdown.innerHTML = '<div class="autocomplete-item">Загрузка...</div>';
                        dropdown.classList.remove('hidden');
                        
                        const response = await fetch(HH_API[apiEndpoint]);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        
                        const data = await response.json();
                        autocompleteData[type] = dataMapper(data);
                        
                        const filtered = autocompleteData[type].filter(item => 
                            item.text.toLowerCase().includes(query.toLowerCase())
                        );
                        
                        dropdown.innerHTML = '';
                        
                        if (filtered.length === 0) {
                            const noResults = document.createElement('div');
                            noResults.className = 'autocomplete-item text-gray-500';
                            noResults.textContent = 'Ничего не найдено';
                            dropdown.appendChild(noResults);
                            return;
                        }
                        
                        filtered.slice(0, 10).forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'autocomplete-item';
                            div.textContent = item.text;
                            div.dataset.id = item.id;
                            div.dataset.text = item.text;
                            
                            div.addEventListener('click', () => {
                                addTag(item.id, item.text, type, tagsContainer, hiddenInput);
                                input.value = '';
                                dropdown.classList.add('hidden');
                            });
                            
                            dropdown.appendChild(div);
                        });
                        
                    } catch (error) {
                        dropdown.innerHTML = '<div class="autocomplete-item text-red-500">Ошибка загрузки</div>';
                    }
                }, 300);
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }
        
        function addTag(id, text, type, tagsContainer, hiddenInput) {
            if (selectedValues[type].has(id)) return;
            
            selectedValues[type].set(id, { id, text });
            updateHiddenInput(type, hiddenInput);
            
            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.innerHTML = `${text}<span class="tag-remove" data-id="${id}">&times;</span>`;
            
            tag.querySelector('.tag-remove').addEventListener('click', () => {
                removeTag(id, type, tag, hiddenInput);
            });
            
            tagsContainer.appendChild(tag);
        }
        
        function removeTag(id, type, tagElement, hiddenInput) {
            selectedValues[type].delete(id);
            tagElement.remove();
            updateHiddenInput(type, hiddenInput);
        }
        
        function updateHiddenInput(type, hiddenInput) {
            const ids = Array.from(selectedValues[type].keys());
            hiddenInput.value = ids.join(',');
        }
        
        const dataMappers = {
            professional_roles: (data) => {
                const items = [];
                data.categories.forEach(category => {
                    category.roles.forEach(role => {
                        items.push({ id: role.id, text: role.name });
                    });
                });
                return items;
            },
            areas: (data) => {
                const items = [];
                function processArea(area, path = '') {
                    const currentPath = path ? `${path} → ${area.name}` : area.name;
                    items.push({ id: area.id, text: currentPath });
                    if (area.areas) area.areas.forEach(child => processArea(child, currentPath));
                }
                data.forEach(area => processArea(area));
                return items;
            },
            industries: (data) => data.map(industry => ({ id: industry.id, text: industry.name }))
        };
        
        // ОСНОВНЫЕ ФУНКЦИИ
        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('resultsCount').classList.add('hidden');
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Идет поиск...';
        }
        
        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-search mr-2"></i> Найти компании';
        }
        
        function showError(message) {
            hideLoading();
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        // ОТПРАВКА ФОРМЫ (БЕЗ ПРОКСИ!)
        async function submitForm(formData) {
            try {
                console.log('Отправка данных:', formData);
                
                const params = new URLSearchParams();
                params.append('vacancy', formData.vacancy);
                params.append('search_in', formData.search_in.join(','));
                
                if (formData.professional_roles.length > 0) {
                    params.append('professional_roles', formData.professional_roles.join(','));
                }
                
                if (formData.areas.length > 0) {
                    params.append('areas', formData.areas.join(','));
                }
                
                if (formData.industries.length > 0) {
                    params.append('industries', formData.industries.join(','));
                }
                
                if (formData.limit) {
                    params.append('limit', formData.limit);
                }
                
                const targetUrl = N8N_WEBHOOK_URL + '?' + params.toString();
                console.log('URL запроса:', targetUrl);
                
                // ПРОСТОЙ FETCH БЕЗ ПРОКСИ
                const response = await fetch(targetUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                console.log('Статус ответа:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Ошибка сервера: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Получены данные:', data);
                displayResults(data);
                
            } catch (error) {
                console.error('Ошибка:', error);
                showError(error.message);
            }
        }
        
        function displayResults(results) {
    hideLoading();
    
    const container = document.getElementById('resultsContainer');
    const resultsCount = document.getElementById('resultsCount');
    
    // ОТЛАДКА
    console.log('Что пришло в displayResults:', results);
    console.log('Тип:', typeof results);
    console.log('Is array?', Array.isArray(results));
    
    // Обрабатываем разные форматы
    let resultsArray = [];
    
    // Если это массив - берем как есть
    if (Array.isArray(results)) {
        resultsArray = results;
    } 
    // Если это объект с полем data (массив)
    else if (results && results.data && Array.isArray(results.data)) {
        resultsArray = results.data;
    }
    // Если это просто объект (не массив) - оборачиваем в массив
    else if (results && typeof results === 'object' && !Array.isArray(results)) {
        console.log('Это объект, а не массив. Оборачиваю в массив.');
        resultsArray = [results]; // Оборачиваем одиночный объект в массив
    }
    // Если это строка (например, JSON строка)
    else if (typeof results === 'string') {
        try {
            const parsed = JSON.parse(results);
            if (Array.isArray(parsed)) {
                resultsArray = parsed;
            } else if (parsed && parsed.data) {
                resultsArray = parsed.data;
            } else {
                resultsArray = [parsed];
            }
        } catch (e) {
            console.error('Не удалось распарсить JSON:', e);
        }
    }
    
    console.log('Обработанный массив:', resultsArray);
    console.log('Количество элементов:', resultsArray.length);
    
    // Если нет результатов
    if (resultsArray.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-10">
                <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-gray-700 font-semibold text-lg mb-2">Ничего не найдено</h3>
                <p class="text-gray-500">Попробуйте изменить параметры поиска</p>
            </div>
        `;
        resultsCount.classList.add('hidden');
        return;
    }
    
    // Очищаем контейнер
    container.innerHTML = '';
    
    // Создаем карточки
    resultsArray.forEach((company, index) => {
        console.log(`Создаю карточку ${index + 1}:`, company);
        
        const card = document.createElement('div');
        card.className = 'company-card bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300';
        
        const name = company.name || 'Название не указано';
        const website = company.site || company.website || '';
        const inn = company.inn || company.tax_id || 'Не указан';
        const hhLink = company.vacancy || company.url || company.hh_link || '';
        
        // Проверяем, не пустой ли сайт
        const displayWebsite = (website && website !== 'http://' && website !== 'https://' && website !== 'null') 
            ? website 
            : '';
        
        card.innerHTML = `
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-3 truncate">${name}</h3>
                
                <div class="space-y-3">
                    <div class="flex items-start">
                        <span class="font-medium text-gray-700 min-w-[60px]">ИНН:</span>
                        <span class="text-gray-900 font-mono">${inn}</span>
                    </div>
                    
                    ${displayWebsite ? `
                    <div class="flex items-start">
                        <span class="font-medium text-gray-700 min-w-[60px]">Сайт:</span>
                        <a href="${displayWebsite}" target="_blank" rel="noopener noreferrer" 
                           class="text-blue-600 hover:text-blue-800 hover:underline truncate flex-1">
                            ${displayWebsite.replace(/^https?:\/\//, '').replace(/^http:\/\//, '')}
                        </a>
                    </div>
                    ` : ''}
                    
                    ${hhLink ? `
                    <div class="flex items-start">
                        <span class="font-medium text-gray-700 min-w-[60px]">HH.ru:</span>
                        <a href="${hhLink}" target="_blank" rel="noopener noreferrer" 
                           class="text-blue-600 hover:text-blue-800 hover:underline truncate flex-1">
                            Открыть вакансию
                        </a>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
    
    // Показываем количество результатов
    resultsCount.classList.remove('hidden');
    resultsCount.innerHTML = `Найдено компаний: <span class="font-semibold text-blue-600">${resultsArray.length}</span>`;
    
    // Прокручиваем к результатам
    document.getElementById('resultsContainer').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'nearest' 
    });
}
        
        // ИНИЦИАЛИЗАЦИЯ
        document.addEventListener('DOMContentLoaded', function() {
            // Автокомплиты
            setupAutocomplete('professional_roles_input', 'professional_roles_dropdown', 
                'professional_roles_tags', 'professional_roles', 'professional_roles', dataMappers.professional_roles);
            setupAutocomplete('areas_input', 'areas_dropdown', 
                'areas_tags', 'areas', 'areas', dataMappers.areas);
            setupAutocomplete('industries_input', 'industries_dropdown', 
                'industries_tags', 'industries', 'industries', dataMappers.industries);
            
            // Обработчик формы
            document.getElementById('searchForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    vacancy: document.getElementById('vacancy').value.trim(),
                    search_in: Array.from(document.querySelectorAll('input[name="search_in"]:checked'))
                        .map(checkbox => checkbox.value),
                    professional_roles: document.getElementById('professional_roles').value
                        .split(',').filter(id => id !== '').map(id => parseInt(id)),
                    areas: document.getElementById('areas').value
                        .split(',').filter(id => id !== '').map(id => parseInt(id)),
                    industries: document.getElementById('industries').value
                        .split(',').filter(id => id !== '').map(id => parseInt(id)),
                    limit: document.getElementById('limit').value || 50
                };
                
                if (!formData.vacancy) {
                    alert('Введите вакансию');
                    return;
                }
                
                showLoading();
                await submitForm(formData);
            });
            
            // Кнопка "Попробовать снова"
            document.getElementById('retryButton').addEventListener('click', function() {
                document.getElementById('errorState').classList.add('hidden');
                document.getElementById('searchForm').dispatchEvent(new Event('submit'));
            });
        });
    </script>
</body>
</html>
